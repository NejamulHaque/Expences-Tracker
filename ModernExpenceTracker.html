<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Professional Expense Tracker | Haque & Sons</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        .smooth-transition {
            transition: all 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-100 min-h-screen p-4 flex flex-col">
    <main class="flex-grow">
        <div class="max-w-6xl mx-auto space-y-6">
            <!-- Header with theme toggle -->
            <header class="flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <i class="fas fa-wallet text-blue-600 text-2xl"></i>
                    <h1 class="text-2xl md:text-3xl font-bold">Expense Tracker</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="theme-toggle" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700">
                        <i class="fas fa-moon dark:hidden"></i>
                        <i class="fas fa-sun hidden dark:block"></i>
                    </button>
                </div>
            </header>

            <!-- Stats Cards -->
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-md border-l-4 border-blue-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 dark:text-gray-400 text-sm">Total Expenses</p>
                            <p id="total-expense-amount" class="text-2xl font-bold">$0.00</p>
                        </div>
                        <i class="fas fa-chart-line text-blue-500 text-xl"></i>
                    </div>
                </div>
                <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-md border-l-4 border-green-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 dark:text-gray-400 text-sm">This Month</p>
                            <p id="monthly-expense" class="text-2xl font-bold">$0.00</p>
                        </div>
                        <i class="fas fa-calendar-alt text-green-500 text-xl"></i>
                    </div>
                </div>
                <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-md border-l-4 border-purple-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 dark:text-gray-400 text-sm">Top Category</p>
                            <p id="top-category" class="text-2xl font-bold">-</p>
                        </div>
                        <i class="fas fa-tags text-purple-500 text-xl"></i>
                    </div>
                </div>
            </div>

            <!-- Form Section -->
            <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fas fa-plus-circle mr-2 text-blue-500"></i>
                    Add New Expense
                </h2>
                <form id="expense-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="date" class="block text-sm font-medium mb-1">Date</label>
                        <input type="date" id="date" required 
                               class="w-full p-3 rounded-lg bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 smooth-transition" />
                    </div>
                    <div>
                        <label for="category" class="block text-sm font-medium mb-1">Category</label>
                        <select id="category" required 
                                class="w-full p-3 rounded-lg bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 smooth-transition">
                            <option value="">Select Category</option>
                            <option value="Food">Food</option>
                            <option value="Transportation">Transportation</option>
                            <option value="Housing">Housing</option>
                            <option value="Utilities">Utilities</option>
                            <option value="Healthcare">Healthcare</option>
                            <option value="Entertainment">Entertainment</option>
                            <option value="Education">Education</option>
                            <option value="Shopping">Shopping</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label for="amount" class="block text-sm font-medium mb-1">Amount</label>
                        <div class="relative">
                            <span class="absolute left-3 top-3 text-gray-500 dark:text-gray-400 currency-symbol">$</span>
                            <input type="number" id="amount" placeholder="0.00" step="0.01" min="0" required 
                                   class="w-full pl-8 p-3 rounded-lg bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 smooth-transition" />
                        </div>
                    </div>
                    <div>
                        <label for="description" class="block text-sm font-medium mb-1">Description</label>
                        <textarea id="description" placeholder="Add notes..." 
                                  class="w-full p-3 rounded-lg bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 smooth-transition"></textarea>
                    </div>
                    <div class="md:col-span-2 flex justify-end space-x-3">
                        <button type="button" id="cancel-edit" class="px-6 py-3 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 smooth-transition hidden">
                            Cancel
                        </button>
                        <button type="submit" id="submit-btn" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 smooth-transition flex items-center">
                            <i class="fas fa-save mr-2"></i> Save Expense
                        </button>
                    </div>
                </form>
            </div>

            <!-- Controls Section -->
            <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-4">
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-filter text-blue-500"></i>
                        <h2 class="text-xl font-semibold">Expense Controls</h2>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <button id="export-csv" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 smooth-transition flex items-center justify-center">
                            <i class="fas fa-file-export mr-2"></i> Export
                        </button>
                        <button id="delete-all" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 smooth-transition flex items-center justify-center">
                            <i class="fas fa-trash-alt mr-2"></i> Clear All
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label for="currency" class="block text-sm font-medium mb-1">Currency</label>
                        <select id="currency" class="w-full p-2 rounded-lg bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 smooth-transition">
                            <option value="USD">USD ($)</option>
                            <option value="EUR">EUR (€)</option>
                            <option value="GBP">GBP (£)</option>
                            <option value="INR">INR (₹)</option>
                            <option value="JPY">JPY (¥)</option>
                        </select>
                    </div>
                    <div>
                        <label for="filter-category" class="block text-sm font-medium mb-1">Filter by Category</label>
                        <select id="filter-category" class="w-full p-2 rounded-lg bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 smooth-transition">
                            <option value="">All Categories</option>
                            <option value="Food">Food</option>
                            <option value="Transportation">Transportation</option>
                            <option value="Housing">Housing</option>
                            <option value="Utilities">Utilities</option>
                            <option value="Healthcare">Healthcare</option>
                            <option value="Entertainment">Entertainment</option>
                            <option value="Education">Education</option>
                            <option value="Shopping">Shopping</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label for="search-input" class="block text-sm font-medium mb-1">Search Expenses</label>
                        <div class="relative">
                            <input type="search" id="search-input" placeholder="Search..." 
                                   class="w-full pl-10 p-2 rounded-lg bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 smooth-transition" />
                            <i class="fas fa-search absolute left-3 top-3 text-gray-500 dark:text-gray-400"></i>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 mb-4">
                    <button id="sort-date-asc" class="px-3 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 smooth-transition flex items-center justify-center">
                        <i class="fas fa-sort-amount-up-alt mr-2"></i> Date ↑
                    </button>
                    <button id="sort-date-desc" class="px-3 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 smooth-transition flex items-center justify-center">
                        <i class="fas fa-sort-amount-down mr-2"></i> Date ↓
                    </button>
                    <button id="sort-amount-asc" class="px-3 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 smooth-transition flex items-center justify-center">
                        <i class="fas fa-sort-numeric-up mr-2"></i> Amount ↑
                    </button>
                    <button id="sort-amount-desc" class="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 smooth-transition flex items-center justify-center">
                        <i class="fas fa-sort-numeric-down-alt mr-2"></i> Amount ↓
                    </button>
                </div>
            </div>

            <!-- Expenses Table -->
            <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg overflow-x-auto">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold flex items-center">
                        <i class="fas fa-list-ul mr-2 text-blue-500"></i>
                        Expense Records
                    </h2>
                    <p id="records-count" class="text-sm text-gray-500 dark:text-gray-400">0 records</p>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-gray-100 dark:bg-gray-700">
                            <tr>
                                <th class="p-3 font-medium">Date</th>
                                <th class="p-3 font-medium">Category</th>
                                <th class="p-3 font-medium">Amount</th>
                                <th class="p-3 font-medium">Description</th>
                                <th class="p-3 font-medium text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="expense-table-body" class="divide-y divide-gray-200 dark:divide-gray-700"></tbody>
                    </table>
                </div>
                
                <div id="empty-state" class="text-center py-10">
                    <i class="fas fa-wallet text-4xl text-gray-400 mb-3"></i>
                    <h3 class="text-lg font-medium text-gray-500">No expenses recorded yet</h3>
                    <p class="text-gray-400">Add your first expense to get started</p>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg">
                    <h2 class="text-xl font-semibold mb-4 flex items-center">
                        <i class="fas fa-chart-pie mr-2 text-blue-500"></i>
                        Expense Distribution
                    </h2>
                    <div class="chart-container">
                        <canvas id="expense-chart"></canvas>
                    </div>
                </div>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg">
                    <h2 class="text-xl font-semibold mb-4 flex items-center">
                        <i class="fas fa-chart-line mr-2 text-blue-500"></i>
                        Monthly Trend
                    </h2>
                    <div class="chart-container">
                        <canvas id="monthly-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="text-center text-sm text-gray-500 dark:text-gray-400 mt-10 pt-4 border-t border-gray-200 dark:border-gray-800">
        <div class="flex items-center justify-center space-x-4 mb-2">
            <a href="#" class="hover:text-blue-500 smooth-transition"><i class="fab fa-facebook-f"></i></a>
            <a href="#" class="hover:text-blue-400 smooth-transition"><i class="fab fa-twitter"></i></a>
            <a href="#" class="hover:text-red-500 smooth-transition"><i class="fab fa-youtube"></i></a>
            <a href="#" class="hover:text-gray-700 dark:hover:text-white smooth-transition"><i class="fab fa-github"></i></a>
        </div>
        <p>© <span id="current-year"></span> Haque & Sons. All rights reserved.</p>
        <p class="mt-1">v1.0.0</p>
    </footer>

    <script>
        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            // Set current year in footer
            document.getElementById('current-year').textContent = new Date().getFullYear();
            
            // Load expenses from localStorage
            loadExpenses();
            
            // Initialize charts
            initCharts();
            
            // Set default date to today
            document.getElementById('date').valueAsDate = new Date();
        });

        // Application state
        let expenses = JSON.parse(localStorage.getItem('expenses')) || [];
        let currentEditIndex = null;
        let selectedCurrency = localStorage.getItem('currency') || 'USD';
        let chart, monthlyChart;

        // DOM elements
        const form = document.getElementById("expense-form");
        const tableBody = document.getElementById("expense-table-body");
        const emptyState = document.getElementById("empty-state");
        const totalExpenseEl = document.getElementById("total-expense-amount");
        const monthlyExpenseEl = document.getElementById("monthly-expense");
        const topCategoryEl = document.getElementById("top-category");
        const recordsCountEl = document.getElementById("records-count");
        const chartCtx = document.getElementById("expense-chart");
        const monthlyCtx = document.getElementById("monthly-chart");
        const themeToggle = document.getElementById("theme-toggle");
        const currencySelector = document.getElementById("currency");
        const cancelEditBtn = document.getElementById("cancel-edit");
        const submitBtn = document.getElementById("submit-btn");

        // Currency formatting
        const currencyFormats = {
            'USD': { symbol: '$', locale: 'en-US' },
            'EUR': { symbol: '€', locale: 'de-DE' },
            'GBP': { symbol: '£', locale: 'en-GB' },
            'INR': { symbol: '₹', locale: 'en-IN' },
            'JPY': { symbol: '¥', locale: 'ja-JP' }
        };

        function formatCurrency(amount) {
            const format = currencyFormats[selectedCurrency];
            return new Intl.NumberFormat(format.locale, {
                style: 'currency',
                currency: selectedCurrency,
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }

        // Update currency symbol in input fields
        function updateCurrencySymbols() {
            document.querySelectorAll('.currency-symbol').forEach(el => {
                el.textContent = currencyFormats[selectedCurrency].symbol;
            });
        }

        // Initialize charts
        function initCharts() {
            // Main expense chart (pie/doughnut)
            chart = new Chart(chartCtx, {
                type: 'doughnut',
                data: { labels: [], datasets: [{
                    data: [],
                    backgroundColor: [
                        'rgba(59, 130, 246, 0.7)',
                        'rgba(16, 185, 129, 0.7)',
                        'rgba(245, 158, 11, 0.7)',
                        'rgba(139, 92, 246, 0.7)',
                        'rgba(244, 63, 94, 0.7)',
                        'rgba(20, 184, 166, 0.7)',
                        'rgba(249, 115, 22, 0.7)',
                        'rgba(236, 72, 153, 0.7)',
                    ],
                    borderWidth: 1
                }]},
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${formatCurrency(value)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // Monthly trend chart (line)
            monthlyChart = new Chart(monthlyCtx, {
                type: 'line',
                data: { labels: [], datasets: [{
                    label: 'Monthly Expenses',
                    data: [],
                    fill: false,
                    borderColor: 'rgba(59, 130, 246, 0.7)',
                    tension: 0.1
                }]},
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        // Update charts with current data
        function updateCharts() {
            // Update main chart (by category)
            const categoryData = {};
            expenses.forEach(expense => {
                categoryData[expense.category] = (categoryData[expense.category] || 0) + expense.amount;
            });

            chart.data.labels = Object.keys(categoryData);
            chart.data.datasets[0].data = Object.values(categoryData);
            chart.update();

            // Update monthly trend chart
            const monthlyData = {};
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            
            expenses.forEach(expense => {
                const date = new Date(expense.date);
                const monthYear = `${monthNames[date.getMonth()]} ${date.getFullYear()}`;
                monthlyData[monthYear] = (monthlyData[monthYear] || 0) + expense.amount;
            });

            // Sort months chronologically
            const sortedMonths = Object.keys(monthlyData).sort((a, b) => {
                const [monthA, yearA] = a.split(' ');
                const [monthB, yearB] = b.split(' ');
                const monthIndexA = monthNames.indexOf(monthA);
                const monthIndexB = monthNames.indexOf(monthB);
                return new Date(yearA, monthIndexA) - new Date(yearB, monthIndexB);
            });

            monthlyChart.data.labels = sortedMonths;
            monthlyChart.data.datasets[0].data = sortedMonths.map(month => monthlyData[month]);
            monthlyChart.update();
        }

        // Update statistics
        function updateStats() {
            // Total expenses
            const total = expenses.reduce((sum, expense) => sum + expense.amount, 0);
            totalExpenseEl.textContent = formatCurrency(total);

            // Monthly expenses (current month)
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const monthlyTotal = expenses.reduce((sum, expense) => {
                const expenseDate = new Date(expense.date);
                if (expenseDate.getMonth() === currentMonth && expenseDate.getFullYear() === currentYear) {
                    return sum + expense.amount;
                }
                return sum;
            }, 0);
            monthlyExpenseEl.textContent = formatCurrency(monthlyTotal);

            // Top category
            const categoryTotals = {};
            expenses.forEach(expense => {
                categoryTotals[expense.category] = (categoryTotals[expense.category] || 0) + expense.amount;
            });
            
            let topCategory = '-';
            let maxAmount = 0;
            for (const [category, amount] of Object.entries(categoryTotals)) {
                if (amount > maxAmount) {
                    maxAmount = amount;
                    topCategory = category;
                }
            }
            topCategoryEl.textContent = topCategory;

            // Records count
            recordsCountEl.textContent = `${expenses.length} ${expenses.length === 1 ? 'record' : 'records'}`;
        }

        // Update the expenses table
        function updateTable(data = expenses) {
            if (data.length === 0) {
                tableBody.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            tableBody.innerHTML = '';
            
            data.forEach((expense, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 dark:hover:bg-gray-700 smooth-transition fade-in';
                row.innerHTML = `
                    <td class="p-3">${formatDate(expense.date)}</td>
                    <td class="p-3">
                        <span class="px-2 py-1 rounded-full text-xs font-medium 
                            ${getCategoryColorClass(expense.category)}">
                            ${expense.category}
                        </span>
                    </td>
                    <td class="p-3 font-medium">${formatCurrency(expense.amount)}</td>
                    <td class="p-3 text-gray-600 dark:text-gray-300">${expense.description || '-'}</td>
                    <td class="p-3 text-right">
                        <button onclick="editExpense(${index})" class="mr-2 text-blue-500 hover:text-blue-700 smooth-transition">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteExpense(${index})" class="text-red-500 hover:text-red-700 smooth-transition">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            updateStats();
            updateCharts();
            saveExpenses();
        }

        // Format date for display
        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return new Date(dateString).toLocaleDateString(undefined, options);
        }

        // Get color class for category badge
        function getCategoryColorClass(category) {
            const colors = {
                'Food': 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200',
                'Transportation': 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200',
                'Housing': 'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200',
                'Utilities': 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200',
                'Healthcare': 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200',
                'Entertainment': 'bg-pink-100 text-pink-800 dark:bg-pink-900 dark:text-pink-200',
                'Education': 'bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-200',
                'Shopping': 'bg-teal-100 text-teal-800 dark:bg-teal-900 dark:text-teal-200',
                'Other': 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200'
            };
            return colors[category] || colors['Other'];
        }

        // Edit expense
        window.editExpense = function(index) {
            const expense = expenses[index];
            document.getElementById("date").value = expense.date;
            document.getElementById("category").value = expense.category;
            document.getElementById("amount").value = expense.amount;
            document.getElementById("description").value = expense.description || '';
            
            currentEditIndex = index;
            cancelEditBtn.classList.remove('hidden');
            submitBtn.innerHTML = '<i class="fas fa-save mr-2"></i> Update Expense';
            
            // Scroll to form
            document.getElementById("expense-form").scrollIntoView({ behavior: 'smooth' });
        };

        // Cancel edit
        cancelEditBtn.onclick = function() {
            form.reset();
            document.getElementById("date").valueAsDate = new Date();
            currentEditIndex = null;
            cancelEditBtn.classList.add('hidden');
            submitBtn.innerHTML = '<i class="fas fa-save mr-2"></i> Save Expense';
        };

        // Delete expense
        window.deleteExpense = function(index) {
            if (confirm('Are you sure you want to delete this expense?')) {
                expenses.splice(index, 1);
                updateTable();
                
                // If we're editing this expense, cancel edit
                if (currentEditIndex === index) {
                    cancelEditBtn.click();
                } else if (currentEditIndex > index) {
                    currentEditIndex--;
                }
            }
        };

        // Form submission
        form.onsubmit = function(e) {
            e.preventDefault();
            
            const date = document.getElementById("date").value;
            const category = document.getElementById("category").value;
            const amount = parseFloat(document.getElementById("amount").value);
            const description = document.getElementById("description").value;
            
            if (!date || !category || isNaN(amount) || amount <= 0) {
                alert('Please fill all required fields with valid values');
                return;
            }
            
            const expense = { date, category, amount, description };
            
            if (currentEditIndex !== null) {
                // Update existing expense
                expenses[currentEditIndex] = expense;
                currentEditIndex = null;
                cancelEditBtn.classList.add('hidden');
                submitBtn.innerHTML = '<i class="fas fa-save mr-2"></i> Save Expense';
            } else {
                // Add new expense
                expenses.push(expense);
            }
            
            form.reset();
            document.getElementById("date").valueAsDate = new Date();
            updateTable();
        };

        // Filter by category
        document.getElementById("filter-category").onchange = function() {
            const category = this.value;
            if (!category) return updateTable();
            
            const filtered = expenses.filter(expense => expense.category === category);
            updateTable(filtered);
        };

        // Search expenses
        document.getElementById("search-input").oninput = function() {
            const query = this.value.toLowerCase();
            const filtered = expenses.filter(expense => 
                expense.description.toLowerCase().includes(query) || 
                expense.category.toLowerCase().includes(query) ||
                expense.amount.toString().includes(query) ||
                formatDate(expense.date).toLowerCase().includes(query)
            );
            updateTable(filtered);
        };

        // Sorting functions
        document.getElementById("sort-date-asc").onclick = function() {
            expenses.sort((a, b) => new Date(a.date) - new Date(b.date));
            updateTable();
        };
        
        document.getElementById("sort-date-desc").onclick = function() {
            expenses.sort((a, b) => new Date(b.date) - new Date(a.date));
            updateTable();
        };
        
        document.getElementById("sort-amount-asc").onclick = function() {
            expenses.sort((a, b) => a.amount - b.amount);
            updateTable();
        };
        
        document.getElementById("sort-amount-desc").onclick = function() {
            expenses.sort((a, b) => b.amount - a.amount);
            updateTable();
        };

        // Delete all expenses
        document.getElementById("delete-all").onclick = function() {
            if (expenses.length === 0) {
                alert('No expenses to delete');
                return;
            }
            
            if (confirm('Are you sure you want to delete ALL expenses? This cannot be undone.')) {
                expenses = [];
                updateTable();
                
                // If editing, cancel edit
                if (currentEditIndex !== null) {
                    cancelEditBtn.click();
                }
            }
        };

        // Export to CSV
        document.getElementById("export-csv").onclick = function() {
            if (expenses.length === 0) {
                alert('No expenses to export');
                return;
            }
            
            const headers = ['Date', 'Category', 'Amount', 'Description'];
            const csvRows = [
                headers.join(','),
                ...expenses.map(expense => 
                    `${expense.date},"${expense.category}",${expense.amount},"${expense.description || ''}"`
                )
            ];
            
            const csv = csvRows.join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `expenses_${new Date().toISOString().slice(0,10)}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // Currency change
        currencySelector.value = selectedCurrency;
        currencySelector.onchange = function() {
            selectedCurrency = this.value;
            localStorage.setItem('currency', selectedCurrency);
            updateCurrencySymbols();
            updateTable();
        };
        updateCurrencySymbols();

        // Theme toggle
        themeToggle.onclick = function() {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
            
            // Update charts for theme change
            updateCharts();
        };

        // Check for saved theme preference
        if (localStorage.getItem('theme') === 'dark' || 
            (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        }

        // Save expenses to localStorage
        function saveExpenses() {
            localStorage.setItem('expenses', JSON.stringify(expenses));
        }

        // Load expenses from localStorage
        function loadExpenses() {
            const savedExpenses = localStorage.getItem('expenses');
            if (savedExpenses) {
                expenses = JSON.parse(savedExpenses);
                updateTable();
            }
        }
    </script>
</body>
</html>
